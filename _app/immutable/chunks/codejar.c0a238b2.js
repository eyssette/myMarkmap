const $=window;function Q(s,k,W={}){const l=Object.assign({tab:"	",indentOn:/[({\[]$/,moveToNewLine:/^[)}\]]/,spellcheck:!1,catchTab:!0,preserveIdent:!0,addClosing:!0,history:!0,window:$},W),O=l.window,C=O.document;let R=[],h=[],f=-1,x=!1,b,_;s.setAttribute("contenteditable","plaintext-only"),s.setAttribute("spellcheck",l.spellcheck?"true":"false"),s.style.outline="none",s.style.overflowWrap="break-word",s.style.overflowY="auto",s.style.whiteSpace="pre-wrap";let E=!1;k(s),s.contentEditable!=="plaintext-only"&&(E=!0),E&&s.setAttribute("contenteditable","true");const q=j(()=>{const t=u();k(s,t),d(t)},30);let L=!1;const H=t=>!U(t)&&!B(t)&&t.key!=="Meta"&&t.key!=="Control"&&t.key!=="Alt"&&!t.key.startsWith("Arrow"),F=j(t=>{H(t)&&(T(),L=!1)},300),N=(t,e)=>{R.push([t,e]),s.addEventListener(t,e)};N("keydown",t=>{t.defaultPrevented||(_=w(),l.preserveIdent?I(t):P(t),l.catchTab&&Z(t),l.addClosing&&X(t),l.history&&(z(t),H(t)&&!L&&(T(),L=!0)),E&&!J(t)&&d(u()))}),N("keyup",t=>{t.defaultPrevented||t.isComposing||(_!==w()&&q(),F(t),b&&b(w()))}),N("focus",t=>{x=!0}),N("blur",t=>{x=!1}),N("paste",t=>{T(),G(t),T(),b&&b(w())});function u(){const t=m(),e={start:0,end:0,dir:void 0};let{anchorNode:n,anchorOffset:r,focusNode:o,focusOffset:i}=t;if(!n||!o)throw"error1";if(n===s&&o===s)return e.start=r>0&&s.textContent?s.textContent.length:0,e.end=i>0&&s.textContent?s.textContent.length:0,e.dir=i>=r?"->":"<-",e;if(n.nodeType===Node.ELEMENT_NODE){const a=C.createTextNode("");n.insertBefore(a,n.childNodes[r]),n=a,r=0}if(o.nodeType===Node.ELEMENT_NODE){const a=C.createTextNode("");o.insertBefore(a,o.childNodes[i]),o=a,i=0}return K(s,a=>{if(a===n&&a===o)return e.start+=r,e.end+=i,e.dir=r<=i?"->":"<-","stop";if(a===n)if(e.start+=r,!e.dir)e.dir="->";else return"stop";else if(a===o)if(e.end+=i,!e.dir)e.dir="<-";else return"stop";a.nodeType===Node.TEXT_NODE&&(e.dir!="->"&&(e.start+=a.nodeValue.length),e.dir!="<-"&&(e.end+=a.nodeValue.length))}),s.normalize(),e}function d(t){const e=m();let n,r=0,o,i=0;if(t.dir||(t.dir="->"),t.start<0&&(t.start=0),t.end<0&&(t.end=0),t.dir=="<-"){const{start:c,end:y}=t;t.start=y,t.end=c}let a=0;K(s,c=>{if(c.nodeType!==Node.TEXT_NODE)return;const y=(c.nodeValue||"").length;if(a+y>t.start&&(n||(n=c,r=t.start-a),a+y>t.end))return o=c,i=t.end-a,"stop";a+=y}),n||(n=s,r=s.childNodes.length),o||(o=s,i=s.childNodes.length),t.dir=="<-"&&([n,r,o,i]=[o,i,n,r]),e.setBaseAndExtent(n,r,o,i)}function S(){const e=m().getRangeAt(0),n=C.createRange();return n.selectNodeContents(s),n.setEnd(e.startContainer,e.startOffset),n.toString()}function M(){const e=m().getRangeAt(0),n=C.createRange();return n.selectNodeContents(s),n.setStart(e.endContainer,e.endOffset),n.toString()}function I(t){if(t.key==="Enter"){const e=S(),n=M();let[r]=V(e),o=r;if(l.indentOn.test(e)&&(o+=l.tab),o.length>0?(p(t),t.stopPropagation(),g(`
`+o)):P(t),o!==r&&l.moveToNewLine.test(n)){const i=u();g(`
`+r),d(i)}}}function P(t){if(E&&t.key==="Enter")if(p(t),t.stopPropagation(),M()==""){g(`
 `);const e=u();e.start=--e.end,d(e)}else g(`
`)}function X(t){const e=`([{'"`,n=`)]}'"`,r=M(),o=S(),i=o.substr(o.length-1)==="\\",a=r.substr(0,1);if(n.includes(t.key)&&!i&&a===t.key){const c=u();p(t),c.start=++c.end,d(c)}else if(e.includes(t.key)&&!i&&(`"'`.includes(t.key)||[""," ",`
`].includes(a))){p(t);const c=u(),y=c.start==c.end?"":m().toString(),Y=t.key+y+n[e.indexOf(t.key)];g(Y),c.start++,c.end++,d(c)}}function Z(t){if(t.key==="Tab")if(p(t),t.shiftKey){const e=S();let[n,r]=V(e);if(n.length>0){const o=u(),i=Math.min(l.tab.length,n.length);d({start:r,end:r+i}),C.execCommand("delete"),o.start-=i,o.end-=i,d(o)}}else g(l.tab)}function z(t){if(U(t)){p(t),f--;const e=h[f];e&&(s.innerHTML=e.html,d(e.pos)),f<0&&(f=0)}if(B(t)){p(t),f++;const e=h[f];e&&(s.innerHTML=e.html,d(e.pos)),f>=h.length&&f--}}function T(){if(!x)return;const t=s.innerHTML,e=u(),n=h[f];if(n&&n.html===t&&n.pos.start===e.start&&n.pos.end===e.end)return;f++,h[f]={html:t,pos:e},h.splice(f+1);const r=300;f>r&&(f=r,h.splice(0,1))}function G(t){p(t);const e=(t.originalEvent||t).clipboardData.getData("text/plain").replace(/\r/g,""),n=u();g(e),k(s),d({start:Math.min(n.start,n.end)+e.length,end:Math.min(n.start,n.end)+e.length,dir:"<-"})}function K(t,e){const n=[];t.firstChild&&n.push(t.firstChild);let r=n.pop();for(;r&&e(r)!=="stop";)r.nextSibling&&n.push(r.nextSibling),r.firstChild&&n.push(r.firstChild),r=n.pop()}function A(t){return t.metaKey||t.ctrlKey}function U(t){return A(t)&&!t.shiftKey&&D(t)==="Z"}function B(t){return A(t)&&t.shiftKey&&D(t)==="Z"}function J(t){return A(t)&&D(t)==="C"}function D(t){let e=t.key||t.keyCode||t.which;if(e)return(typeof e=="string"?e:String.fromCharCode(e)).toUpperCase()}function g(t){t=t.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;"),C.execCommand("insertHTML",!1,t)}function j(t,e){let n=0;return(...r)=>{clearTimeout(n),n=O.setTimeout(()=>t(...r),e)}}function V(t){let e=t.length-1;for(;e>=0&&t[e]!==`
`;)e--;e++;let n=e;for(;n<t.length&&/[ \t]/.test(t[n]);)n++;return[t.substring(e,n)||"",e,n]}function w(){return s.textContent||""}function p(t){t.preventDefault()}function m(){var t;return((t=s.parentNode)===null||t===void 0?void 0:t.nodeType)==Node.DOCUMENT_FRAGMENT_NODE?s.parentNode.getSelection():O.getSelection()}return{updateOptions(t){Object.assign(l,t)},updateCode(t){s.textContent=t,k(s)},onUpdate(t){b=t},toString:w,save:u,restore:d,recordHistory:T,destroy(){for(let[t,e]of R)s.removeEventListener(t,e)}}}export{Q as CodeJar};
