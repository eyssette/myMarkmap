const Y=window;function $(s,N,F={}){const l=Object.assign({tab:"	",indentOn:/{$/,spellcheck:!1,catchTab:!0,preserveIdent:!0,addClosing:!0,history:!0,window:Y},F),m=l.window,T=m.document;let L=[],g=[],f=-1,E=!1,b,R,D=navigator.userAgent.toLowerCase().indexOf("firefox")>-1;s.setAttribute("contentEditable",D?"true":"plaintext-only"),s.setAttribute("spellcheck",l.spellcheck?"true":"false"),s.style.outline="none",s.style.overflowWrap="break-word",s.style.overflowY="auto",s.style.resize="vertical",s.style.whiteSpace="pre-wrap",N(s);const V=U(()=>{const t=d();N(s,t),c(t)},30);let x=!1;const H=t=>!K(t)&&!j(t)&&t.key!=="Meta"&&t.key!=="Control"&&t.key!=="Alt"&&!t.key.startsWith("Arrow"),W=U(t=>{H(t)&&(w(),x=!1)},300),C=(t,e)=>{L.push([t,e]),s.addEventListener(t,e)};C("keydown",t=>{t.defaultPrevented||(R=k(),l.preserveIdent?q(t):M(t),l.catchTab&&I(t),l.addClosing&&B(t),l.history&&(X(t),H(t)&&!x&&(w(),x=!0)))}),C("keyup",t=>{t.defaultPrevented||t.isComposing||(R!==k()&&V(),W(t),b&&b(k()))}),C("focus",t=>{E=!0}),C("blur",t=>{E=!1}),C("paste",t=>{w(),G(t),w(),b&&b(k())});function d(){const t=O(),e={start:0,end:0,dir:void 0};return P(s,n=>{if(n===t.anchorNode&&n===t.focusNode)return e.start+=t.anchorOffset,e.end+=t.focusOffset,e.dir=t.anchorOffset<=t.focusOffset?"->":"<-","stop";if(n===t.anchorNode)if(e.start+=t.anchorOffset,!e.dir)e.dir="->";else return"stop";else if(n===t.focusNode)if(e.end+=t.focusOffset,!e.dir)e.dir="<-";else return"stop";n.nodeType===Node.TEXT_NODE&&(e.dir!="->"&&(e.start+=n.nodeValue.length),e.dir!="<-"&&(e.end+=n.nodeValue.length))}),e}function c(t){const e=O();let n,r=0,o,a=0;if(t.dir||(t.dir="->"),t.start<0&&(t.start=0),t.end<0&&(t.end=0),t.dir=="<-"){const{start:i,end:y}=t;t.start=y,t.end=i}let p=0;P(s,i=>{if(i.nodeType!==Node.TEXT_NODE)return;const y=(i.nodeValue||"").length;if(p+y>=t.start&&(n||(n=i,r=t.start-p),p+y>=t.end))return o=i,a=t.end-p,"stop";p+=y}),n||(n=s),o||(o=s),t.dir=="<-"&&([n,r,o,a]=[o,a,n,r]),e.setBaseAndExtent(n,r,o,a)}function S(){const e=O().getRangeAt(0),n=T.createRange();return n.selectNodeContents(s),n.setEnd(e.startContainer,e.startOffset),n.toString()}function A(){const e=O().getRangeAt(0),n=T.createRange();return n.selectNodeContents(s),n.setStart(e.endContainer,e.endOffset),n.toString()}function q(t){if(t.key==="Enter"){const e=S(),n=A();let[r]=z(e),o=r;if(l.indentOn.test(e)&&(o+=l.tab),o.length>0?(u(t),t.stopPropagation(),h(`
`+o)):M(t),o!==r&&n[0]==="}"){const a=d();h(`
`+r),c(a)}}}function M(t){if(D&&t.key==="Enter")if(u(t),t.stopPropagation(),A()==""){h(`
 `);const e=d();e.start=--e.end,c(e)}else h(`
`)}function B(t){const e=`([{'"`,n=`)]}'"`,r=A(),o=S(),a=o.substr(o.length-1)==="\\",p=r.substr(0,1);if(n.includes(t.key)&&!a&&p===t.key){const i=d();u(t),i.start=++i.end,c(i)}else if(e.includes(t.key)&&!a&&(`"'`.includes(t.key)||[""," ",`
`].includes(p))){u(t);const i=d(),y=i.start==i.end?"":O().toString(),J=t.key+y+n[e.indexOf(t.key)];h(J),i.start++,i.end++,c(i)}}function I(t){if(t.key==="Tab")if(u(t),t.shiftKey){const e=S();let[n,r]=z(e);if(n.length>0){const o=d(),a=Math.min(l.tab.length,n.length);c({start:r,end:r+a}),T.execCommand("delete"),o.start-=a,o.end-=a,c(o)}}else h(l.tab)}function X(t){if(K(t)){u(t),f--;const e=g[f];e&&(s.innerHTML=e.html,c(e.pos)),f<0&&(f=0)}if(j(t)){u(t),f++;const e=g[f];e&&(s.innerHTML=e.html,c(e.pos)),f>=g.length&&f--}}function w(){if(!E)return;const t=s.innerHTML,e=d(),n=g[f];if(n&&n.html===t&&n.pos.start===e.start&&n.pos.end===e.end)return;f++,g[f]={html:t,pos:e},g.splice(f+1);const r=300;f>r&&(f=r,g.splice(0,1))}function G(t){u(t);const e=(t.originalEvent||t).clipboardData.getData("text/plain").replace(/\r/g,""),n=d();h(e),N(s),c({start:n.start+e.length,end:n.start+e.length})}function P(t,e){const n=[];t.firstChild&&n.push(t.firstChild);let r=n.pop();for(;r&&e(r)!=="stop";)r.nextSibling&&n.push(r.nextSibling),r.firstChild&&n.push(r.firstChild),r=n.pop()}function _(t){return t.metaKey||t.ctrlKey}function K(t){return _(t)&&!t.shiftKey&&t.key==="z"}function j(t){return _(t)&&t.shiftKey&&t.key==="z"}function h(t){t=t.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;"),T.execCommand("insertHTML",!1,t)}function U(t,e){let n=0;return(...r)=>{clearTimeout(n),n=m.setTimeout(()=>t(...r),e)}}function z(t){let e=t.length-1;for(;e>=0&&t[e]!==`
`;)e--;e++;let n=e;for(;n<t.length&&/[ \t]/.test(t[n]);)n++;return[t.substring(e,n)||"",e,n]}function k(){return s.textContent||""}function u(t){t.preventDefault()}function O(){var t;return((t=s.parentNode)===null||t===void 0?void 0:t.nodeType)==Node.DOCUMENT_FRAGMENT_NODE?s.parentNode.getSelection():m.getSelection()}return{updateOptions(t){t=Object.assign(Object.assign({},t),t)},updateCode(t){s.textContent=t,N(s)},onUpdate(t){b=t},toString:k,save:d,restore:c,recordHistory:w,destroy(){for(let[t,e]of L)s.removeEventListener(t,e)}}}export{$ as CodeJar};
